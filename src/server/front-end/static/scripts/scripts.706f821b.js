"use strict";function resizeCanvas(){var a=$("#drawRates"),b=a.parent().width(),c=35*b/50,d=2*b/5,e=b/50*12;a.get(0).width=b,a.get(0).height=d;var f=document.getElementById("drawNeurons");f.width=b,f.height=d,f=document.getElementById("drawScores"),f.width=c,f.height=e,null!==source&&currentIdx>=0&&(refreshGrafs(),printScoreGraf(f,source.score10,source.score100,settings))}function calculateDistance(a){var b=Number.MIN_VALUE,c=Number.MAX_VALUE;return a.forEach(function(a){a>b&&(b=a),c>a&&(c=a)}),{max:b,min:c,valid:b>=c,scale:1}}function drawPoint(a,b,c,d,e){a.save(),a.lineWidth=d/3,a.beginPath(),a.arc(b,c,d,0,2*Math.PI,!1),a.fillStyle=e.bg,a.fill(),a.strokeStyle=e.pnt,a.stroke(),a.beginPath(),a.arc(b,c,d/3,0,2*Math.PI,!1),a.fillStyle=e.fg,a.fill(),a.restore()}function drawFlag(a,b,c,d,e,f){a.save(),a.setLineDash([]),a.lineWidth=1,a.strokeStyle=f.fg,a.fillStyle=f.flg,a.beginPath(),a.arc(b,c,d-d/4,0,Math.PI,!1),a.closePath(),a.fill(),a.stroke(),a.beginPath(),a.moveTo(b-.5,c-.5),a.lineTo(b-.5,c-e-.5),a.lineTo(b-.5+d,c-3*e/4-.5),a.lineTo(b-.5,c-e/2-.5),a.closePath(),a.fill(),a.stroke(),a.restore()}function drawScore(a,b,c,d,e,f,g,h,i){var j=5;a.save(),a.lineWidth=j,a.strokeStyle=g.fg,a.fillStyle=g.fg;var k=c+e-d/3;a.beginPath(),a.moveTo(b+.5,k-.5),a.lineTo(b+d-.5,k-.5),a.stroke(),a.lineWidth=1,a.beginPath(),a.arc(b+d/2,k-.5,d/3,0,Math.PI,!1),a.closePath(),a.fill(),a.stroke(),a.beginPath(),a.moveTo(b+d/10-.5,k-.5),a.lineTo(b+d/10-.5,2*d/5),a.arc(b+d/2+.5,2*d/5+1.5,2*d/5+1,Math.PI,0,!1),a.lineTo(b+9*d/10+.5,k-.5),a.stroke(),a.font=f,a.fillStyle=g.bg;var l=a.measureText(h).width;a.fillText(h,b+d/2-l/2,k+j+7-.5);var m=Math.round(100*i);55>m?a.fillStyle=g.errorBg:65>m?a.fillStyle=g.waitBg:a.fillStyle=g.successBg;var n=k*(1-i),o=k-n-j/2;a.fillRect(b+d/10+.5,n-.5,8*d/10-.5,o),a.fillStyle=g.fg;var p=m+"%",q=a.measureText(p).width;a.fillText(p,b+d/2-q/2,n+o/2+3),a.restore()}function drawTimeline(a,b,c,d,e,f,g,h,i){var j=[];i.time.forEach(function(a){j.push(new Date(1e3*a))});var k=i.result<0,l=j.length,m=(b-e-f)/(l+(k?1:0)),n={};a.save(),a.font=h;for(var o=0;l>o;o++){var p=j[o].getDate();n[p]=n[p]||[],n[p].push(o);var q=j[o],r=q.getHours()+":"+(q.getMinutes()<10?"0":"")+q.getMinutes(),s=a.measureText(r),t=e+m*o;if(!k&&o===l-1&&i.prediction>=0){var u=(i.levels-1)/2;i.result===i.prediction||i.result<u&&i.prediction<u||i.result>u&&i.prediction>u?a.fillStyle=g.successBg:a.fillStyle=g.errorBg,a.fillRect(t,0,t+m,c)}a.fillStyle=g.fg,a.beginPath(),a.moveTo(t,d+.5),a.lineWidth=3,a.lineTo(t+(m/2-s.width/2-2),d+.5),a.stroke(),a.fillText(r,t+(m/2-s.width/2),d+2.5),a.beginPath(),a.moveTo(t+(m/2+s.width/2+2),d+.5),a.lineWidth=3,a.lineTo(t+m,d+.5),a.stroke()}if(k){var v=e+m*l;i.prediction>=0&&(a.fillStyle=g.waitBg,a.fillRect(v,0,v+m,c)),a.fillStyle=g.fg,a.beginPath(),a.moveTo(v,d+.5),a.lineWidth=3,a.lineTo(v+m,d+.5),a.stroke()}a.restore()}function drawRates(a,b,c,d,e,f,g,h,i){var j=calculateDistance(i.data);if(j.valid){var k=0;j.scale=(c-d-h)/(j.max-j.min);var l=i.data.length,m=(b-e-f)/(l+(i.result<0?1:0)),n=[];for(k=0;l>k;k++)n.push({x:e+m/2+m*k,y:c-(i.data[k]-j.min)*j.scale});for(a.save(),a.lineWidth=1,a.strokeStyle=g.fg,k=0;l-1>k;k++)a.beginPath(),a.moveTo(n[k].x,n[k].y),a.lineTo(n[k+1].x,n[k+1].y),a.stroke();for(a.restore(),k=0;l>k;k++)drawPoint(a,n[k].x,n[k].y,h,g)}}function drawNeurons(a,b,c,d,e,f,g,h,i,j){var k=(c-d-i)/(j.levels-1),l=[],m=0;for(a.save(),a.font=g,a.setLineDash([1,3]),a.lineWidth=1,a.strokeStyle=h.fg,m=0;m<j.levels;m++){var n=c-k*m;l.push(n);var o=""+(m+1),p=a.measureText(o).width;a.fillText(o,e,n+2.5),a.beginPath(),a.moveTo(e+p+3,n+.5),a.lineTo(b-f,n+.5),a.stroke()}var q=j.source.length,r=(b-e-f)/(q+1),s=[];for(m=0;q>m;m++)s.push(e+r/2+r*m);for(a.setLineDash([]),m=0;q-1>m;m++)a.beginPath(),a.moveTo(s[m],l[j.source[m]]),a.lineTo(s[m+1],l[j.source[m+1]]),a.stroke();for(j.prediction>=0&&j.result!==j.prediction&&(a.setLineDash([1,3]),a.beginPath(),a.moveTo(s[q-1],l[j.source[q-1]]),a.lineTo(s[q-1]+r,l[j.prediction]),a.stroke()),j.result>=0&&(a.setLineDash([]),a.beginPath(),a.moveTo(s[q-1],l[j.source[q-1]]),a.lineTo(s[q-1]+r,l[j.result]),a.stroke()),a.restore(),m=0;q>m;m++)drawPoint(a,s[m],l[j.source[m]],i,h);j.result>=0&&drawPoint(a,s[q-1]+r,l[j.result],i,h),j.prediction>=0&&drawFlag(a,s[q-1]+r,l[j.prediction],i,2*i,h)}function printRatesGraph(a,b,c){var d=a.getContext("2d"),e=a.width,f=a.height;d.clearRect(0,0,e,f),drawTimeline(d,e,f,f-c.margin.bottom,c.margin.left,c.margin.right,c.colorScheme1,c.timeline.font,b),drawRates(d,e,f-c.margin.bottom-20,c.margin.top,c.margin.left,c.margin.right,c.colorScheme1,c.rate.point.radius,b)}function printNeuroGraph(a,b,c){var d=a.getContext("2d"),e=a.width,f=a.height;d.clearRect(0,0,e,f),drawTimeline(d,e,f,f-c.margin.bottom,c.margin.left,c.margin.right,c.colorScheme1,c.timeline.font,b),drawNeurons(d,e,f-c.margin.bottom-20,c.margin.top,c.margin.left,c.margin.right,c.timeline.font,c.colorScheme1,c.rate.point.radius,b)}function printScoreGraf(a,b,c,d){var e=a.getContext("2d"),f=a.width,g=a.height,h=f/6;e.clearRect(0,0,f,g),drawScore(e,0,0,h,g,d.score.font,d.colorScheme1,10,b),drawScore(e,f-h,0,h,g,d.score.font,d.colorScheme1,100,c)}function refreshGrafs(){0>currentIdx&&(currentIdx=0),currentIdx>=source.data.length&&(currentIdx=source.data.length-1),printRatesGraph(document.getElementById("drawRates"),source.data[currentIdx],settings),printNeuroGraph(document.getElementById("drawNeurons"),source.data[currentIdx],settings)}function refresh(){null!==source&&(refreshGrafs(),printScoreGraf(document.getElementById("drawScores"),source.score10,source.score100,settings))}function loadSymbol(a){$.get("https://rp-optima.appspot.com/api/json/"+a+"/all",function(a){null!==a&&null!==a.data?(source=a,currentIdx=a.data.length-1,refresh()):window.alert("Error")})}var source=null,currentIdx=-1,settings={margin:{left:10,right:10,top:10,bottom:6},timeline:{font:"9px Calibri",line:{width:3},height:20},rate:{point:{radius:10}},score:{font:"15px Calibri"},colorScheme1:{fg:"#000",bg:"#fff",successBg:"#efe",errorBg:"#fee",waitBg:"#ffe",pnt:"#f9f",flg:"#f66"}};$(function(){$("#next").on("click",function(){null!==source&&(currentIdx++,refreshGrafs())}),$("#prev").on("click",function(){null!==source&&(currentIdx--,refreshGrafs())}),$("#navbarCollapse .dropdown-menu a").click(function(){var a=$(this),b=a.html();null!==b&&3===b.length&&(a.parent().parent().prev("a.dropdown-toggle").html(b+' <span class="caret"></span>'),loadSymbol(b))}),window.addEventListener("resize",resizeCanvas,!1),resizeCanvas(),loadSymbol("eur")});